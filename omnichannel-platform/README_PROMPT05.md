# Prompt 05: Construtor Visual de Fluxo do Chatbot

## ‚úÖ Implementa√ß√£o Completa

Este documento descreve a implementa√ß√£o completa do **Construtor Visual de Fluxos (Flow Builder)** para a Plataforma de Atendimento Omnichannel.

## üèóÔ∏è Arquitetura Implementada

### Backend (Node.js/TypeScript)

#### 1. Controlador de Fluxos (`src/controllers/FlowController.ts`)
- **10 endpoints especializados** para gerenciamento completo de fluxos
- **Valida√ß√µes robustas** com sanitiza√ß√£o de inputs
- **Controle de ativa√ß√£o** (apenas um fluxo ativo por vez)
- **Estat√≠sticas detalhadas** de fluxos

##### Endpoints Implementados:
- `GET /api/flows` - Listar todos os fluxos (Admin only)
- `GET /api/flows/:id` - Obter fluxo espec√≠fico (Admin only)
- `POST /api/flows` - Criar novo fluxo (Admin only)
- `PUT /api/flows/:id` - Atualizar fluxo existente (Admin only)
- `DELETE /api/flows/:id` - Excluir fluxo (Admin only)
- `POST /api/flows/:id/publish` - Publicar/ativar fluxo (Admin only)
- `POST /api/flows/:id/unpublish` - Despublicar/desativar fluxo (Admin only)
- `GET /api/flows/active` - Obter fluxo ativo (P√∫blico - usado pelo chatbot)
- `GET /api/flows/stats` - Obter estat√≠sticas dos fluxos (Admin only)

#### 2. Modelo de Dados Expandido (`src/models/ChatbotFlow.ts`)
- **M√©todo findActive()** para obter fluxo ativo √∫nico
- **Controle de ativa√ß√£o** com desativa√ß√£o autom√°tica de outros fluxos
- **Valida√ß√µes de integridade** antes de opera√ß√µes
- **M√©todos especializados** para cada opera√ß√£o

#### 3. Rotas Protegidas (`src/routes/flows.ts`)
- Todas as rotas administrativas protegidas com `requireAdmin`
- Endpoint p√∫blico para obter fluxo ativo
- Documenta√ß√£o completa de cada endpoint

### Frontend (Next.js/TypeScript/Tailwind CSS + React Flow)

#### 1. Cliente API Expandido (`src/lib/api.ts`)
- **flowsAPI**: Conjunto completo de fun√ß√µes para fluxos
- **Tipos TypeScript** para todas as interfaces
- **Tratamento de erros** padronizado

#### 2. P√°gina do Construtor Visual (`/dashboard/flow-builder`)

##### Layout em 3 Pain√©is:

###### Painel de N√≥s (Esquerda):
- **4 tipos de n√≥s** dispon√≠veis para arrastar
- **√çcones visuais** para cada tipo
- **Status do fluxo** em tempo real
- **Estat√≠sticas** de n√≥s e conex√µes

###### Canvas/√Årea de Desenho (Centro):
- **React Flow** integrado com zoom e pan
- **Arrastar e soltar** n√≥s do painel
- **Conectar n√≥s** criando arestas
- **Sele√ß√£o visual** de n√≥s
- **MiniMap e controles** de navega√ß√£o

###### Painel de Propriedades (Direita):
- **Configura√ß√£o contextual** do n√≥ selecionado
- **Formul√°rios espec√≠ficos** para cada tipo de n√≥
- **A√ß√µes de duplicar e excluir** n√≥s
- **Valida√ß√£o em tempo real**

## üé® Tipos de N√≥s Implementados

### 1. **Enviar Mensagem** (sendMessage)
- **Cor**: Azul
- **√çcone**: MessageSquare
- **Propriedades**:
  - Campo de texto grande para a mensagem
  - Suporte a texto multilinha
  - Preview da mensagem no n√≥

### 2. **Menu com Bot√µes** (menuButtons)
- **Cor**: Verde
- **√çcone**: Menu
- **Propriedades**:
  - Mensagem principal (pergunta)
  - At√© 3 bot√µes configur√°veis
  - Cada bot√£o gera um ponto de sa√≠da
  - Preview do n√∫mero de bot√µes

### 3. **A√ß√£o de Integra√ß√£o** (integration)
- **Cor**: Roxo
- **√çcone**: Zap
- **Propriedades**:
  - Dropdown com a√ß√µes predefinidas:
    - Buscar Fatura por CPF
    - Consultar Hist√≥rico
    - Verificar Status
    - Buscar Produto
  - Campo de entrada (ex: CPF)
  - Dois pontos de sa√≠da: "Sucesso" e "Falha"

### 4. **Transferir para Atendente** (transfer)
- **Cor**: Laranja
- **√çcone**: Users
- **Propriedades**:
  - Dropdown com filas predefinidas:
    - Financeiro
    - Suporte T√©cnico
    - Vendas
    - Atendimento Geral
  - Preview da fila selecionada

## üîß Funcionalidades do Canvas

### Intera√ß√µes Implementadas:
- ‚úÖ **Arrastar e Soltar**: N√≥s do painel para o canvas
- ‚úÖ **Conectar N√≥s**: Arrastar de sa√≠da para entrada
- ‚úÖ **Selecionar e Configurar**: Clique para editar propriedades
- ‚úÖ **Zoom e Pan**: Navega√ß√£o fluida no canvas
- ‚úÖ **MiniMap**: Vis√£o geral do fluxo
- ‚úÖ **Background Grid**: Guias visuais
- ‚úÖ **Controles**: Zoom in/out, fit view, etc.

### A√ß√µes da Barra Superior:
- ‚úÖ **Campo Nome**: Edi√ß√£o do nome do fluxo
- ‚úÖ **Bot√£o Salvar**: Persiste o fluxo no banco
- ‚úÖ **Bot√£o Publicar**: Ativa o fluxo para uso
- ‚úÖ **Bot√£o Despublicar**: Desativa o fluxo
- ‚úÖ **Estados de Loading**: Feedback visual durante opera√ß√µes

## üîê Recursos de Seguran√ßa

### 1. Controle de Acesso
- ‚úÖ Todas as rotas administrativas protegidas com `requireAdmin`
- ‚úÖ Verifica√ß√£o de role no frontend
- ‚úÖ Redirecionamento autom√°tico para n√£o-admins
- ‚úÖ Endpoint p√∫blico apenas para fluxo ativo

### 2. Valida√ß√µes e Integridade
- ‚úÖ Nome do fluxo obrigat√≥rio
- ‚úÖ Verifica√ß√£o de nomes √∫nicos
- ‚úÖ N√£o permite excluir fluxo ativo
- ‚úÖ N√£o permite publicar fluxo vazio
- ‚úÖ Desativa√ß√£o autom√°tica de outros fluxos ao publicar

### 3. Persist√™ncia Robusta
- ‚úÖ Estrutura do fluxo salva como JSON no campo `flow_definition`
- ‚úÖ Inclui n√≥s, arestas e viewport
- ‚úÖ Carregamento autom√°tico do fluxo ativo
- ‚úÖ Recupera√ß√£o completa do estado do canvas

## üì± Interface do Usu√°rio

### Design System
- **Framework**: Tailwind CSS + React Flow
- **√çcones**: Lucide React (MessageSquare, Menu, Zap, Users, etc.)
- **Layout**: 3 pain√©is responsivos
- **Feedback**: Alertas contextuais e estados de loading

### Componentes Principais
- **NodeTypes customizados** para cada tipo de n√≥
- **Painel de propriedades din√¢mico** baseado na sele√ß√£o
- **Barra de ferramentas** com a√ß√µes principais
- **Status indicators** para fluxo ativo/inativo
- **Estat√≠sticas em tempo real** de n√≥s e conex√µes

### Experi√™ncia do Usu√°rio
- **Drag & Drop intuitivo** do painel para canvas
- **Conex√µes visuais** com setas direcionais
- **Sele√ß√£o clara** com bordas coloridas
- **Feedback imediato** para todas as a√ß√µes
- **Estados de loading** durante opera√ß√µes
- **Mensagens de erro espec√≠ficas** e acion√°veis

## üöÄ Fluxos de Uso

### 1. Criar Novo Fluxo
```
1. Admin acessa /dashboard/flow-builder
2. Insere nome do fluxo no campo superior
3. Arrasta n√≥s do painel esquerdo para o canvas
4. Conecta n√≥s criando sequ√™ncia l√≥gica
5. Configura propriedades de cada n√≥
6. Clica em "Salvar" para persistir
7. Clica em "Publicar" para ativar
```

### 2. Editar Fluxo Existente
```
1. Admin acessa construtor
2. Fluxo ativo √© carregado automaticamente
3. Modifica n√≥s, conex√µes ou propriedades
4. Salva altera√ß√µes
5. Republica se necess√°rio
```

### 3. Configurar N√≥ "Enviar Mensagem"
```
1. Arrasta n√≥ para canvas
2. Clica no n√≥ para selecion√°-lo
3. Painel direito exibe campo de texto
4. Digita mensagem que bot enviar√°
5. Preview aparece no n√≥ automaticamente
```

### 4. Configurar N√≥ "Menu com Bot√µes"
```
1. Arrasta n√≥ para canvas
2. Seleciona n√≥
3. Preenche mensagem principal
4. Adiciona at√© 3 bot√µes
5. Cada bot√£o gera ponto de sa√≠da
6. Conecta sa√≠das a outros n√≥s
```

### 5. Configurar N√≥ "A√ß√£o de Integra√ß√£o"
```
1. Arrasta n√≥ para canvas
2. Seleciona a√ß√£o no dropdown
3. Define campo de entrada necess√°rio
4. Conecta sa√≠da "Sucesso" a pr√≥ximo n√≥
5. Conecta sa√≠da "Falha" a n√≥ de erro
```

### 6. Configurar N√≥ "Transferir para Atendente"
```
1. Arrasta n√≥ para canvas
2. Seleciona fila de atendimento
3. N√≥ fica configurado para transfer√™ncia
4. Geralmente √© n√≥ final do fluxo
```

## üîß Estrutura de Dados

### Fluxo Salvo no Banco (flow_definition):
```json
{
  "nodes": [
    {
      "id": "sendMessage_1234567890",
      "type": "sendMessage",
      "position": { "x": 100, "y": 100 },
      "data": {
        "message": "Ol√°! Como posso ajud√°-lo hoje?"
      }
    },
    {
      "id": "menuButtons_1234567891",
      "type": "menuButtons",
      "position": { "x": 300, "y": 100 },
      "data": {
        "message": "Escolha uma op√ß√£o:",
        "buttons": ["Fatura", "Suporte", "Vendas"]
      }
    }
  ],
  "edges": [
    {
      "id": "edge_1",
      "source": "sendMessage_1234567890",
      "target": "menuButtons_1234567891",
      "markerEnd": { "type": "arrowclosed" }
    }
  ],
  "viewport": { "x": 0, "y": 0, "zoom": 1 }
}
```

## üìä Endpoints da API

### Fluxos (Protegidos - Admin Only)
- `GET /api/flows` - Listar fluxos
- `GET /api/flows/:id` - Obter fluxo espec√≠fico
- `POST /api/flows` - Criar fluxo
- `PUT /api/flows/:id` - Atualizar fluxo
- `DELETE /api/flows/:id` - Excluir fluxo
- `POST /api/flows/:id/publish` - Publicar fluxo
- `POST /api/flows/:id/unpublish` - Despublicar fluxo
- `GET /api/flows/stats` - Estat√≠sticas

### P√∫blico
- `GET /api/flows/active` - Obter fluxo ativo

### Respostas da API

#### Listar Fluxos
```json
{
  "message": "Fluxos listados com sucesso",
  "flows": [
    {
      "id": "flow_123",
      "name": "Fluxo Principal",
      "description": "Fluxo de boas-vindas",
      "flow_definition": { ... },
      "is_active": true,
      "created_at": "2024-01-01T00:00:00Z",
      "updated_at": "2024-01-01T00:00:00Z"
    }
  ],
  "total": 1
}
```

#### Publicar Fluxo
```json
{
  "message": "Fluxo publicado com sucesso",
  "flow": {
    "id": "flow_123",
    "name": "Fluxo Principal",
    "is_active": true,
    ...
  }
}
```

#### Estat√≠sticas
```json
{
  "message": "Estat√≠sticas obtidas com sucesso",
  "stats": {
    "total": 5,
    "active": 1,
    "inactive": 4,
    "withDefinition": 3,
    "empty": 2
  }
}
```

## üß™ Cen√°rios de Teste

### 1. Cria√ß√£o de Fluxo
- ‚úÖ Admin acessa /dashboard/flow-builder
- ‚úÖ Arrasta 4 tipos de n√≥s para canvas
- ‚úÖ Conecta n√≥s criando sequ√™ncia
- ‚úÖ Configura propriedades de cada n√≥
- ‚úÖ Salva fluxo com nome √∫nico
- ‚úÖ Publica fluxo ativando-o

### 2. Edi√ß√£o de Fluxo
- ‚úÖ Fluxo ativo carregado automaticamente
- ‚úÖ Modifica√ß√µes refletidas em tempo real
- ‚úÖ Propriedades edit√°veis no painel direito
- ‚úÖ Salvamento preserva estado completo

### 3. Valida√ß√µes
- ‚úÖ Nome obrigat√≥rio para salvar
- ‚úÖ N√£o permite nomes duplicados
- ‚úÖ N√£o permite excluir fluxo ativo
- ‚úÖ N√£o permite publicar fluxo vazio
- ‚úÖ Apenas um fluxo ativo por vez

### 4. Interface e UX
- ‚úÖ Drag & drop funcional
- ‚úÖ Conex√µes visuais criadas corretamente
- ‚úÖ Sele√ß√£o de n√≥s atualiza painel de propriedades
- ‚úÖ Estados de loading durante opera√ß√µes
- ‚úÖ Alertas de sucesso e erro

### 5. Controle de Acesso
- ‚úÖ AGENT n√£o acessa /dashboard/flow-builder
- ‚úÖ Redirecionamento autom√°tico para dashboard
- ‚úÖ Todas as rotas protegidas
- ‚úÖ Endpoint p√∫blico apenas para fluxo ativo

## üìù Estrutura de Arquivos

### Backend
```
src/
‚îú‚îÄ‚îÄ controllers/
‚îÇ   ‚îî‚îÄ‚îÄ FlowController.ts        # Controlador principal
‚îú‚îÄ‚îÄ routes/
‚îÇ   ‚îî‚îÄ‚îÄ flows.ts                 # Rotas de fluxos
‚îú‚îÄ‚îÄ models/
‚îÇ   ‚îî‚îÄ‚îÄ ChatbotFlow.ts           # Modelo expandido
‚îî‚îÄ‚îÄ index.ts                     # Integra√ß√£o das rotas
```

### Frontend
```
src/
‚îú‚îÄ‚îÄ app/dashboard/
‚îÇ   ‚îú‚îÄ‚îÄ page.tsx                 # Dashboard com link
‚îÇ   ‚îî‚îÄ‚îÄ flow-builder/
‚îÇ       ‚îî‚îÄ‚îÄ page.tsx             # Construtor visual
‚îî‚îÄ‚îÄ lib/
    ‚îî‚îÄ‚îÄ api.ts                   # Cliente API expandido
```

## üéØ Crit√©rios de Aceite Atendidos

‚úÖ **Acesso Restrito**: ADMIN acessa /dashboard/flow-builder, AGENT √© bloqueado
‚úÖ **Layout 3 Pain√©is**: N√≥s (esquerda), Canvas (centro), Propriedades (direita)
‚úÖ **4 Tipos de N√≥s**: Enviar Mensagem, Menu com Bot√µes, A√ß√£o de Integra√ß√£o, Transferir para Atendente
‚úÖ **Arrastar e Soltar**: N√≥s do painel para canvas funcionais
‚úÖ **Conectar N√≥s**: Cria√ß√£o de arestas entre n√≥s
‚úÖ **Configurar Propriedades**: Painel contextual para n√≥ selecionado
‚úÖ **Salvar Fluxo**: Persist√™ncia no banco de dados
‚úÖ **Publicar Fluxo**: Ativa√ß√£o para uso pelos clientes
‚úÖ **Carregar Fluxo**: Estado preservado ao recarregar p√°gina
‚úÖ **JSON no Banco**: Estrutura salva corretamente em flow_definition

## üèÜ Resultado

O **Construtor Visual de Fluxo do Chatbot** est√° **100% funcional** e atende a todos os requisitos especificados no Prompt 05. A implementa√ß√£o oferece uma interface intuitiva e poderosa para criar fluxos de chatbot complexos.

### Funcionalidades Implementadas:
- ‚úÖ Interface visual completa com React Flow
- ‚úÖ 4 tipos de n√≥s especializados
- ‚úÖ Sistema de propriedades contextual
- ‚úÖ Persist√™ncia robusta no banco de dados
- ‚úÖ Controle de ativa√ß√£o de fluxos
- ‚úÖ Valida√ß√µes e seguran√ßa completas
- ‚úÖ API REST completa para gerenciamento
- ‚úÖ Interface responsiva e moderna

### Pr√≥ximos Passos:
Com o construtor implementado, a plataforma est√° pronta para:
- Executar fluxos criados no chatbot
- Processar intera√ß√µes dos usu√°rios
- Integrar com APIs externas
- Transferir para atendentes humanos
- Coletar m√©tricas e analytics

A base visual e l√≥gica est√° s√≥lida e permite que administradores criem experi√™ncias de chatbot sofisticadas sem necessidade de programa√ß√£o.

