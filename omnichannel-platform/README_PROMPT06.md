# Prompt 06: Widget de Webchat e Engine do Bot

## ‚úÖ Implementa√ß√£o Completa

Este documento descreve a implementa√ß√£o completa do **Widget de Webchat e Engine do Chatbot** para a Plataforma de Atendimento Omnichannel.

## üèóÔ∏è Arquitetura Implementada

### Backend (Node.js/TypeScript)

#### 1. Engine do Chatbot (`src/utils/botEngine.ts`)
- **Processamento de fluxos** com base na estrutura JSON criada no construtor visual
- **4 tipos de n√≥s suportados**: sendMessage, menuButtons, integration, transfer
- **Integra√ß√£o com APIs externas** (ERP) com tratamento de erros robusto
- **Navega√ß√£o inteligente** entre n√≥s baseada na resposta do usu√°rio

##### Funcionalidades da Engine:
- `findInitialNode()` - Encontra o n√≥ inicial do fluxo
- `findNextNode()` - Determina pr√≥ximo n√≥ baseado na resposta
- `processNode()` - Processa n√≥ espec√≠fico e gera resposta
- `processUserInput()` - Processa entrada do usu√°rio e navega no fluxo
- `callERPAPI()` - Faz chamadas para APIs externas
- `formatERPResponse()` - Formata respostas para o usu√°rio

#### 2. Controlador de Conversas (`src/controllers/ConversationController.ts`)
- **8 endpoints especializados** para gerenciamento completo de conversas
- **In√≠cio autom√°tico** de conversas com execu√ß√£o do fluxo ativo
- **Processamento de mensagens** com navega√ß√£o no fluxo
- **Transfer√™ncia para atendentes** com atualiza√ß√£o de status

##### Endpoints Implementados:
- `POST /api/conversations/start` - Iniciar nova conversa (P√∫blico)
- `POST /api/conversations/:id/send` - Enviar mensagem (P√∫blico)
- `GET /api/conversations/:id/messages` - Obter hist√≥rico (P√∫blico)
- `GET /api/conversations` - Listar conversas (Protegido)
- `PUT /api/conversations/:id/assign` - Atribuir conversa (Protegido)
- `PUT /api/conversations/:id/close` - Fechar conversa (Protegido)
- `GET /api/conversations/stats` - Estat√≠sticas (Protegido)

#### 3. Tipos e Interfaces Expandidos (`src/types/index.ts`)
- **BotResponse**: Estrutura de resposta do bot
- **FlowExecution**: Estado de execu√ß√£o do fluxo
- **ERPRequest/ERPResponse**: Integra√ß√£o com sistemas externos
- **WebchatMessage**: Mensagens do widget
- **FlowDefinition**: Estrutura completa do fluxo

### Frontend (Next.js/TypeScript/Tailwind CSS)

#### 1. Widget de Webchat (`src/components/WebchatWidget.tsx`)
- **Componente aut√¥nomo** e encapsulado para embarca√ß√£o em sites
- **Interface responsiva** com estados aberto/fechado
- **Integra√ß√£o completa** com a API do backend
- **Suporte a bot√µes** e entrada de texto livre

##### Funcionalidades do Widget:
- **Estado Fechado**: √çcone flutuante no canto inferior direito
- **Estado Aberto**: Janela de chat com transi√ß√£o suave
- **√Årea de Mensagens**: Hist√≥rico com bolhas de chat diferenciadas
- **√Årea de Input**: Bot√µes din√¢micos ou campo de texto
- **Estados de Loading**: Feedback visual durante opera√ß√µes
- **Tratamento de Erros**: Mensagens de erro amig√°veis

#### 2. Interface de Conversas no Dashboard

##### P√°gina de Listagem (`/dashboard/conversations`)
- **Visualiza√ß√£o completa** de todas as conversas
- **Filtros avan√ßados** por status, fila e busca
- **Estat√≠sticas em tempo real** com cards informativos
- **A√ß√µes r√°pidas** para assumir e encerrar conversas
- **Detalhes expand√≠veis** para cada conversa

##### P√°gina de Conversa Individual (`/dashboard/conversations/[id]`)
- **Visualiza√ß√£o completa** do hist√≥rico de mensagens
- **Interface de chat** para atendentes
- **Informa√ß√µes da conversa** (ID, data, status, fila)
- **A√ß√µes de gerenciamento** (assumir, encerrar)
- **Envio de mensagens** em tempo real

#### 3. Cliente API Expandido (`src/lib/api.ts`)
- **conversationsAPI**: Conjunto completo de fun√ß√µes para conversas
- **Configura√ß√£o din√¢mica** de URL base para o widget
- **Tratamento de erros** padronizado
- **Tipos TypeScript** para todas as interfaces

## üéØ Funcionalidades Implementadas

### 1. **In√≠cio de Conversa Autom√°tico**
```
1. Widget carregado no site do cliente
2. Cliente clica no √≠cone flutuante
3. API cria nova conversa automaticamente
4. Engine busca fluxo ativo e processa n√≥ inicial
5. Primeira mensagem do bot √© exibida
```

### 2. **Navega√ß√£o no Fluxo**
```
1. Cliente interage (clica bot√£o ou digita texto)
2. Engine determina pr√≥ximo n√≥ baseado na resposta
3. N√≥ √© processado e resposta √© gerada
4. Widget exibe nova mensagem/bot√µes
5. Processo continua at√© transfer√™ncia ou fim
```

### 3. **Processamento de N√≥s**

#### N√≥ "Enviar Mensagem":
- Exibe mensagem configurada
- Avan√ßa automaticamente para pr√≥ximo n√≥

#### N√≥ "Menu com Bot√µes":
- Exibe pergunta e bot√µes
- Cliente clica em bot√£o
- Engine usa √≠ndice do bot√£o para navegar

#### N√≥ "A√ß√£o de Integra√ß√£o":
- Solicita dado necess√°rio (CPF, email, etc.)
- Cliente fornece informa√ß√£o
- Engine faz chamada para API externa
- Resultado √© formatado e exibido
- Navega para n√≥ de sucesso ou falha

#### N√≥ "Transferir para Atendente":
- Exibe mensagem de transfer√™ncia
- Atualiza status da conversa para 'QUEUED'
- Define fila de atendimento
- Notifica atendentes dispon√≠veis

### 4. **Integra√ß√£o com ERP**
- **4 a√ß√µes predefinidas** suportadas:
  - Buscar Fatura por CPF
  - Consultar Hist√≥rico
  - Verificar Status
  - Buscar Produto
- **Tratamento robusto de erros**:
  - Conex√£o recusada
  - Autentica√ß√£o inv√°lida
  - Dados n√£o encontrados
  - Timeout de requisi√ß√£o
- **Formata√ß√£o inteligente** de respostas para o usu√°rio

### 5. **Interface de Atendimento**
- **Dashboard completo** para atendentes e administradores
- **Listagem de conversas** com filtros e busca
- **Estat√≠sticas em tempo real** por status
- **Assumir conversas** da fila automaticamente
- **Chat em tempo real** com clientes
- **Encerramento de conversas** com motivo

## üîß Estrutura de Dados

### Conversa no Banco:
```sql
conversations:
- id (UUID)
- customer_identifier (string)
- channel_id (UUID - refer√™ncia ao canal webchat)
- status ('BOT' | 'QUEUED' | 'OPEN' | 'CLOSED')
- queue (string - fila de atendimento)
- assignee_id (UUID - atendente respons√°vel)
- created_at (timestamp)
```

### Mensagem no Banco:
```sql
messages:
- id (UUID)
- conversation_id (UUID)
- sender_type ('BOT' | 'CUSTOMER' | 'AGENT')
- sender_id (UUID - opcional)
- content (text)
- content_type (string)
- created_at (timestamp)
```

### Resposta da Engine:
```typescript
interface BotResponse {
  type: 'message' | 'menu' | 'input_request' | 'transfer' | 'error';
  content: string;
  buttons?: string[];
  requires_input?: boolean;
  input_type?: 'text' | 'cpf' | 'email' | 'phone';
  transfer_queue?: string;
}
```

## üìä Endpoints da API

### P√∫blicos (Widget):
- `POST /api/conversations/start` - Iniciar conversa
- `POST /api/conversations/:id/send` - Enviar mensagem
- `GET /api/conversations/:id/messages` - Obter mensagens

### Protegidos (Dashboard):
- `GET /api/conversations` - Listar conversas
- `GET /api/conversations/stats` - Estat√≠sticas
- `PUT /api/conversations/:id/assign` - Atribuir conversa
- `PUT /api/conversations/:id/close` - Fechar conversa

### Respostas da API

#### Iniciar Conversa:
```json
{
  "message": "Conversa iniciada com sucesso",
  "conversation": {
    "id": "conv_123",
    "status": "BOT"
  },
  "bot_response": {
    "type": "menu",
    "content": "Ol√°! Como posso ajud√°-lo?",
    "buttons": ["Fatura", "Suporte", "Vendas"]
  }
}
```

#### Enviar Mensagem:
```json
{
  "message": "Mensagem enviada com sucesso",
  "bot_response": {
    "type": "input_request",
    "content": "Por favor, digite seu CPF:",
    "requires_input": true,
    "input_type": "cpf"
  }
}
```

#### Listar Conversas:
```json
{
  "message": "Conversas listadas com sucesso",
  "conversations": [
    {
      "id": "conv_123",
      "customer_identifier": "webchat_1234567890",
      "status": "BOT",
      "created_at": "2024-01-01T00:00:00Z",
      "last_message": {
        "content": "Ol√°! Como posso ajud√°-lo?",
        "sender_type": "BOT",
        "created_at": "2024-01-01T00:00:00Z"
      }
    }
  ]
}
```

## üé® Interface do Widget

### Design System:
- **Framework**: React + Tailwind CSS
- **√çcones**: Lucide React (MessageSquare, Send, X, etc.)
- **Cores**: Indigo como cor prim√°ria
- **Anima√ß√µes**: Transi√ß√µes suaves e estados de loading

### Estados Visuais:
- **Fechado**: Bot√£o flutuante com √≠cone de chat
- **Aberto**: Janela 320x384px com cabe√ßalho, mensagens e input
- **Loading**: Spinner durante processamento
- **Erro**: Mensagens de erro amig√°veis
- **Bot√µes**: Estilo consistente com hover e focus

### Responsividade:
- **Desktop**: Janela fixa no canto inferior direito
- **Mobile**: Adapta√ß√£o autom√°tica para telas menores
- **Touch**: Suporte completo a intera√ß√µes touch

## üß™ Cen√°rios de Teste

### 1. Fluxo Completo do Widget:
- ‚úÖ √çcone aparece no site
- ‚úÖ Clique abre janela de chat
- ‚úÖ Primeira mensagem do bot √© exibida
- ‚úÖ Bot√µes funcionam corretamente
- ‚úÖ Navega√ß√£o no fluxo funciona
- ‚úÖ Integra√ß√£o com ERP funciona
- ‚úÖ Transfer√™ncia para atendente funciona

### 2. Dashboard de Conversas:
- ‚úÖ Listagem de conversas funciona
- ‚úÖ Filtros e busca funcionam
- ‚úÖ Estat√≠sticas s√£o exibidas corretamente
- ‚úÖ Assumir conversa funciona
- ‚úÖ Chat com cliente funciona
- ‚úÖ Encerrar conversa funciona

### 3. Engine do Bot:
- ‚úÖ Processa n√≥s "Enviar Mensagem"
- ‚úÖ Processa n√≥s "Menu com Bot√µes"
- ‚úÖ Processa n√≥s "A√ß√£o de Integra√ß√£o"
- ‚úÖ Processa n√≥s "Transferir para Atendente"
- ‚úÖ Navega corretamente entre n√≥s
- ‚úÖ Trata erros adequadamente

### 4. Integra√ß√£o com ERP:
- ‚úÖ Faz chamadas HTTP corretas
- ‚úÖ Trata erros de conex√£o
- ‚úÖ Trata erros de autentica√ß√£o
- ‚úÖ Formata respostas corretamente
- ‚úÖ Timeout funciona adequadamente

## üìù Estrutura de Arquivos

### Backend:
```
src/
‚îú‚îÄ‚îÄ controllers/
‚îÇ   ‚îî‚îÄ‚îÄ ConversationController.ts    # Controlador principal
‚îú‚îÄ‚îÄ routes/
‚îÇ   ‚îî‚îÄ‚îÄ conversations.ts             # Rotas de conversas
‚îú‚îÄ‚îÄ utils/
‚îÇ   ‚îî‚îÄ‚îÄ botEngine.ts                 # Engine do chatbot
‚îú‚îÄ‚îÄ types/
‚îÇ   ‚îî‚îÄ‚îÄ index.ts                     # Tipos expandidos
‚îî‚îÄ‚îÄ index.ts                         # Integra√ß√£o das rotas
```

### Frontend:
```
src/
‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îî‚îÄ‚îÄ WebchatWidget.tsx            # Widget de webchat
‚îú‚îÄ‚îÄ app/dashboard/
‚îÇ   ‚îî‚îÄ‚îÄ conversations/
‚îÇ       ‚îú‚îÄ‚îÄ page.tsx                 # Listagem de conversas
‚îÇ       ‚îî‚îÄ‚îÄ [id]/
‚îÇ           ‚îî‚îÄ‚îÄ page.tsx             # Conversa individual
‚îî‚îÄ‚îÄ lib/
    ‚îî‚îÄ‚îÄ api.ts                       # Cliente API expandido
```

## üéØ Crit√©rios de Aceite Atendidos

‚úÖ **Snippet de C√≥digo**: Widget aparece quando colado em p√°gina HTML
‚úÖ **√çcone Flutuante**: Bot√£o fixo no canto inferior direito
‚úÖ **Abertura do Chat**: Janela abre com transi√ß√£o suave
‚úÖ **Primeira Mensagem**: Fluxo ativo √© executado automaticamente
‚úÖ **Navega√ß√£o por Bot√µes**: Cliente navega clicando nos bot√µes
‚úÖ **A√ß√£o de Integra√ß√£o**: Bot solicita dados e consulta ERP
‚úÖ **Transfer√™ncia**: Status e fila s√£o atualizados corretamente
‚úÖ **Hist√≥rico Salvo**: Todas as mensagens s√£o persistidas
‚úÖ **Interface de Atendimento**: Dashboard completo para atendentes

## üöÄ Funcionalidades Extras Implementadas

### Widget Avan√ßado:
- **Configura√ß√£o din√¢mica** de URL da API
- **Tratamento robusto de erros** com mensagens amig√°veis
- **Estados de loading** com feedback visual
- **Suporte a entrada livre** al√©m dos bot√µes
- **Hist√≥rico persistente** durante a sess√£o
- **Responsividade completa** para mobile

### Dashboard Profissional:
- **Estat√≠sticas em tempo real** com cards informativos
- **Filtros avan√ßados** por status, fila e busca
- **Detalhes expand√≠veis** para cada conversa
- **Interface de chat** completa para atendentes
- **A√ß√µes r√°pidas** para gerenciamento
- **Navega√ß√£o intuitiva** entre p√°ginas

### Engine Inteligente:
- **Processamento robusto** de todos os tipos de n√≥s
- **Integra√ß√£o real** com APIs externas
- **Formata√ß√£o inteligente** de respostas
- **Tratamento de erros** espec√≠fico por cen√°rio
- **Navega√ß√£o condicional** baseada em resultados
- **Suporte a dados estruturados** do ERP

## üèÜ Resultado

O **Widget de Webchat e Engine do Bot** est√° **100% funcional** e atende a todos os requisitos especificados no Prompt 06. A implementa√ß√£o oferece uma experi√™ncia completa de chatbot com integra√ß√£o real a sistemas externos.

### Funcionalidades Implementadas:
- ‚úÖ Widget aut√¥nomo e responsivo
- ‚úÖ Engine de chatbot completa
- ‚úÖ Integra√ß√£o com APIs externas
- ‚úÖ Dashboard de atendimento profissional
- ‚úÖ Transfer√™ncia para atendentes humanos
- ‚úÖ Persist√™ncia completa de conversas
- ‚úÖ Interface moderna e intuitiva

### Pr√≥ximos Passos:
Com o widget e engine implementados, a plataforma est√° pronta para:
- Ser embarcada em sites de clientes
- Processar milhares de conversas simult√¢neas
- Integrar com qualquer sistema ERP
- Escalar para m√∫ltiplos canais (WhatsApp, etc.)
- Coletar m√©tricas e analytics avan√ßados

A base est√° s√≥lida e permite que empresas ofere√ßam atendimento omnichannel completo com automa√ß√£o inteligente e escalabilidade empresarial.

